# .agentic-rules

version: 2
project: timebank-protocol
mission: Enable a trustworthy, auditable time-credit protocol for mutual aid.

## 1) Decision Priority (Strict)

1. Ledger correctness and invariant safety
2. Fairness, abuse prevention, and participant protection
3. Determinism and auditability
4. Test reliability and CI signal quality
5. UX clarity for coordinators and members
6. Delivery speed

## 2) Scope and Change Budget

- One objective per PR.
- Max one primary subsystem per PR unless explicitly requested:
  - backend protocol/ledger, or
  - frontend coordinator/member workflow, or
  - docs/governance/automation.
- If scope expands, stop and update acceptance criteria before coding.
- Reject scope creep that does not move the active story outcome.

## 3) Architecture and Source of Truth

- Canonical balances and trust logic are backend-owned (Java).
- Frontend must render protocol state, not define it.
- API/policy shape changes require OpenAPI + policy metadata updates in same PR.
- Rule changes require explicit assumptions and version traceability.
- `docs/community/current-backlog.md` is weekly execution source of truth.

## 4) Non-Negotiable Prohibitions

Do not commit:

- generated artifacts: `apps/web-react/dist/*`, `apps/web-react/test-results/*`
- local screenshots/audit outputs (`*.png`, `*.jpg`) unless issue explicitly requires artifacts
- temp/editor/cache files and local logs
- malformed docs/config (invalid JSON, broken markdown, malformed bullets)

Do not do:

- bypass or weaken validation (`skipTests` for backend validation is prohibited)
- hidden dependency churn
- undocumented policy/behavior changes
- silent contract drift between backend and frontend

## 5) Dependency Governance

- Default: no new dependencies.
- If needed, PR must include:
  - why native/project-local alternative is insufficient
  - runtime vs dev-only classification
  - security/update footprint
  - rollback/removal plan

## 6) Quality Gates Before Push

Required:

- `npm run quality:quick`
- `npm run backlog:current:check`
- `npm run agent:context:check`

Conditional:

- If Java backend changed: `mvn -q test` in `apps/api-java`
- If contract or policy metadata changed: run matching gate and verify consistency
- If docs changed: ensure links/examples remain valid
- If frontend changed: run Playwright CLI visual audit and produce evidence under `output/playwright/`

## 7) Testing and Regression Rules

- Every bugfix must add a regression test.
- Every rule change must include deterministic ledger coverage.
- Every behavior change must ship with tests and docs in same PR.
- No flaky-test acceptance without mitigation note and follow-up issue.

## 8) Security, Fairness, and Trust

- Never leak secrets in logs/docs/examples.
- Keep threshold and anti-abuse decisions explicit and explainable.
- Preserve immutable audit trail for moderation and policy actions.
- Avoid hidden policy shifts; rule changes must be visible and documented.
- Prefer fail-closed behavior for invalid or ambiguous ledger input.

## 9) PR Evidence Contract (Mandatory)

PR body must include:

- objective and story/issue ID
- files changed by layer (backend/frontend/contracts/docs)
- commands executed with pass/fail outcome
- fairness/abuse risk notes and rollback plan
- migration impact (`none` when not applicable)
- explicit note if other-agent changes were included
- `UX Evidence (Playwright)` section (mandatory for frontend-impacting PRs; `N/A` must be justified)

## 10) Rejection Criteria

Reject the PR if any is true:

- CI fails or required checks are skipped
- generated artifacts are committed
- contract/policy changed without OpenAPI/metadata alignment
- behavior changed without test evidence
- malformed markdown/json/config introduced
- objective is mixed with unrelated work

## 11) Stop Conditions

Pause and ask for clarification when:

- fairness or policy impact is ambiguous
- breaking change is implied but not approved
- security/privacy impact is uncertain
- contract/policy intent is unclear

## 12) Definition of Excellent

A change is excellent only if it is:

- correct
- deterministic
- auditable
- fair
- secure
- tested
- documented
- scoped
- reversible

## 13) Visual Value Rule

Visual experience quality is treated as 70% of perceived product value.

- Frontend changes without Playwright CLI evidence are considered incomplete.
- Prefer CLI-first browser automation (`playwright-cli`) over ad-hoc claims.
