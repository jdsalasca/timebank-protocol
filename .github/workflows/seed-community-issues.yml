name: Seed Community Issues

on:
  workflow_dispatch:

permissions:
  issues: write

jobs:
  seed:
    runs-on: ubuntu-latest
    steps:
      - name: Seed timebank backlog issues
        uses: actions/github-script@v7
        with:
          script: |
            const labels = [
              { name: "good first issue", color: "7057ff", description: "Good for first-time contributors" },
              { name: "help wanted", color: "008672", description: "Maintainers welcome contributions" },
              { name: "priority:P0", color: "b60205", description: "Highest priority" },
              { name: "priority:P1", color: "d93f0b", description: "Medium priority" },
              { name: "priority:P2", color: "fbca04", description: "Strategic priority" },
              { name: "type:story", color: "1d76db", description: "Detailed executable story" },
              { name: "protocol-critical", color: "5319e7", description: "Touches core protocol invariants" },
              { name: "anti-abuse", color: "0e8a16", description: "Trust and abuse prevention" }
            ];

            for (const label of labels) {
              try {
                await github.rest.issues.createLabel({ owner: context.repo.owner, repo: context.repo.repo, ...label });
              } catch (error) {
                if (error.status !== 422) throw error;
              }
            }

            const p0 = [
              "ledger: enforce strict transaction schema and replay protection",
              "ledger: implement canonical balance recomputation from raw events",
              "ledger: add immutable transaction and event IDs",
              "protocol: add configurable negative-balance threshold policy",
              "protocol: add dispute and confirmation events as first-class records",
              "anti-abuse: detect velocity anomalies for new members",
              "anti-abuse: implement suspicious debt accumulation alerts",
              "matching: add skill + availability matching v1",
              "dashboard: add coordinator fairness and risk panel",
              "ci: add ledger reproducibility quality gate"
            ].map((title) => ({ title, labels: ["priority:P0", "help wanted", "good first issue", "protocol-critical"] }));

            const p1 = [
              "messaging: request accepted and completion reminder workflows",
              "reputation: on-time completion and reliability scoring",
              "dashboard: network health and transaction velocity metrics",
              "operations: coordinator weekly digest generation",
              "operations: unresolved disputes triage workflow",
              "fairness: contribution distribution and debt concentration heatmap",
              "contracts: version policy metadata and threshold assumptions",
              "governance: transparent policy-change log",
              "scripts: monthly protocol health report generation",
              "alerts: urgent-needs broadcast mode"
            ].map((title) => ({ title, labels: ["priority:P1", "help wanted", "good first issue", "anti-abuse"] }));

            const p2 = [
              "federation: cross-community interoperability contract",
              "identity: portable time wallet and trust passport starter",
              "proof: verifiable proof-of-care attestations",
              "mobile: offline-first field transaction signing",
              "policy: community voting module for protocol parameters"
            ].map((title) => ({ title, labels: ["priority:P2", "help wanted", "good first issue"] }));

            const stories = [
              "story:TBP-P0-001 harden ledger schema and replay protections",
              "story:TBP-P0-002 implement deterministic balance recomputation",
              "story:TBP-P0-003 introduce immutable ledger event identifiers",
              "story:TBP-P0-004 add negative threshold policy enforcement",
              "story:TBP-P0-005 make disputes and confirmations first-class events",
              "story:TBP-P0-006 ship anti-abuse anomaly alerts for debt velocity",
              "story:TBP-P0-007 deliver coordinator fairness dashboard v1",
              "story:TBP-P0-008 add reproducibility gate for ledger outputs",
              "story:TBP-P1-001 add reputation scoring and explainability",
              "story:TBP-P1-002 build weekly operations digest automation",
              "story:TBP-P1-003 version policy metadata and expose through API",
              "story:TBP-P1-004 add dispute triage and intervention workflow",
              "story:TBP-P1-005 add member recovery guidance engine",
              "story:TBP-P1-006 add trust explainability timeline endpoint",
              "story:TBP-P1-007 add pilot health snapshot exports",
              "story:TBP-P2-001 design federation-ready community contracts",
              "story:TBP-P2-002 prototype proof-of-care attestations",
              "story:TBP-P2-004 build policy simulation sandbox for threshold/reputation",
              "story:TBP-P2-005 design low-connectivity mobile workflow and sync policy"
            ].map((title) => {
              const priority = title.includes("TBP-P0-") ? "priority:P0" : title.includes("TBP-P1-") ? "priority:P1" : "priority:P2";
              return { title, labels: [priority, "help wanted", "good first issue", "type:story"] };
            });

            const seeds = [...p0, ...p1, ...p2, ...stories];

            const openIssues = await github.paginate(github.rest.issues.listForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              per_page: 100
            });

            for (const seed of seeds) {
              if (openIssues.some((issue) => issue.title === seed.title)) {
                core.info(`Issue exists: ${seed.title}`);
                continue;
              }

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: seed.title,
                labels: seed.labels,
                body: [
                  `Priority: ${seed.labels.find((l) => l.startsWith("priority:")) || "priority:P1"}`,
                  "",
                  "## Problem",
                  "Describe the protocol/community pain and affected users.",
                  "",
                  "## Proposed change",
                  "Define a small vertical slice.",
                  "",
                  "## Acceptance criteria",
                  "- [ ] Protocol behavior deterministic and testable",
                  "- [ ] Ledger/audit invariants preserved",
                  "",
                  "## Validation commands",
                  "- [ ] npm test",
                  "- [ ] quality gates for backend/frontend",
                  "",
                  "## Definition of done",
                  "- [ ] Implementation complete",
                  "- [ ] Tests added/updated",
                  "- [ ] Docs updated",
                  "- [ ] Changelog updated if behavior changed"
                ].join("\n")
              });
            }
