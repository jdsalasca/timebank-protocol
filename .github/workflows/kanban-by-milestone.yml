name: Kanban by Milestone

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"
  issues:
    types: [opened, edited, closed, reopened, labeled, unlabeled, milestoned, demilestoned]

permissions:
  contents: write
  issues: read

jobs:
  generate-kanban:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build kanban markdown
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");

            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "all",
              per_page: 100
            });

            const filtered = issues.filter((item) => !item.pull_request);
            const now = new Date();
            const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

            const byMilestone = new Map();

            function statusFor(issue) {
              const labels = issue.labels.map((label) => typeof label === "string" ? label : label.name);
              if (issue.state === "closed") return "DONE";
              if (labels.includes("status:in-progress")) return "IN_PROGRESS";
              if (labels.includes("status:blocked")) return "BLOCKED";
              if (labels.includes("status:done")) return "DONE";
              return "TODO";
            }

            for (const issue of filtered) {
              const milestone = issue.milestone?.title ?? "No Milestone";
              if (!byMilestone.has(milestone)) {
                byMilestone.set(milestone, {
                  TODO: [],
                  IN_PROGRESS: [],
                  BLOCKED: [],
                  DONE: []
                });
              }
              byMilestone.get(milestone)[statusFor(issue)].push(issue);
            }

            const weeklyThroughput = filtered.filter((issue) => {
              if (!issue.closed_at) return false;
              return new Date(issue.closed_at) >= sevenDaysAgo;
            }).length;

            const openBlockedCount = filtered.filter((issue) => {
              if (issue.state !== "open") return false;
              const labels = issue.labels.map((label) => typeof label === "string" ? label : label.name);
              return labels.includes("status:blocked") || labels.includes("blocked");
            }).length;

            const issueEvents = await github.paginate(github.rest.issues.listEventsForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            const weeklyReopened = issueEvents.filter((event) => {
              if (event.event !== "reopened") return false;
              if (event.issue?.pull_request) return false;
              if (!event.created_at) return false;
              return new Date(event.created_at) >= sevenDaysAgo;
            }).length;

            const milestoneOrder = Array.from(byMilestone.keys()).sort((a, b) => {
              if (a === "No Milestone") return 1;
              if (b === "No Milestone") return -1;
              return a.localeCompare(b);
            });

            const lines = [];
            lines.push("# Kanban by Milestone");
            lines.push("");
            lines.push(`Last updated: ${new Date().toISOString()}`);
            lines.push("");
            lines.push("Status labels used by this board:");
            lines.push("- `status:todo`");
            lines.push("- `status:in-progress`");
            lines.push("- `status:blocked`");
            lines.push("- `status:done`");
            lines.push("");
            lines.push("## Weekly Delivery Metrics");
            lines.push("");
            lines.push(`- Window: last 7 days (since ${sevenDaysAgo.toISOString()})`);
            lines.push(`- Throughput (issues closed): ${weeklyThroughput}`);
            lines.push(`- Blockers currently open: ${openBlockedCount}`);
            lines.push(`- Rework signal (issues reopened): ${weeklyReopened}`);
            lines.push("");

            for (const milestone of milestoneOrder) {
              const group = byMilestone.get(milestone);
              lines.push(`## ${milestone}`);
              lines.push("");
              lines.push(`- TODO: ${group.TODO.length}`);
              lines.push(`- IN_PROGRESS: ${group.IN_PROGRESS.length}`);
              lines.push(`- BLOCKED: ${group.BLOCKED.length}`);
              lines.push(`- DONE: ${group.DONE.length}`);
              lines.push("");

              for (const column of ["TODO", "IN_PROGRESS", "BLOCKED", "DONE"]) {
                lines.push(`### ${column}`);
                if (group[column].length === 0) {
                  lines.push("- _No issues_");
                } else {
                  for (const item of group[column]) {
                    lines.push(`- #${item.number} ${item.title}`);
                  }
                }
                lines.push("");
              }
            }

            fs.writeFileSync("docs/kanban.md", lines.join("\n"), "utf8");

            function isoWeekKey(dateObj) {
              const d = new Date(Date.UTC(dateObj.getUTCFullYear(), dateObj.getUTCMonth(), dateObj.getUTCDate()));
              const dayNum = d.getUTCDay() || 7;
              d.setUTCDate(d.getUTCDate() + 4 - dayNum);
              const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
              const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
              return `${d.getUTCFullYear()}-W${String(weekNo).padStart(2, "0")}`;
            }

            const historyPath = "docs/metrics-history.md";
            const weekKey = isoWeekKey(now);
            const currentRow = `| ${weekKey} | ${now.toISOString()} | ${weeklyThroughput} | ${openBlockedCount} | ${weeklyReopened} |`;

            const existingRows = [];
            if (fs.existsSync(historyPath)) {
              const existing = fs.readFileSync(historyPath, "utf8").split("\n");
              for (const line of existing) {
                if (!line.startsWith("| ")) continue;
                if (line.includes("---")) continue;
                if (line.startsWith("| Week ")) continue;
                const parts = line.split("|").map((x) => x.trim()).filter(Boolean);
                if (parts.length < 5) continue;
                if (parts[0] === "Week") continue;
                existingRows.push(line);
              }
            }

            const byWeek = new Map();
            for (const row of existingRows) {
              const parts = row.split("|").map((x) => x.trim()).filter(Boolean);
              byWeek.set(parts[0], row);
            }
            byWeek.set(weekKey, currentRow);

            const sortedWeeks = Array.from(byWeek.keys()).sort((a, b) => a.localeCompare(b));
            const historyLines = [];
            historyLines.push("# Metrics History");
            historyLines.push("");
            historyLines.push("Weekly trend for delivery metrics generated by `kanban-by-milestone` workflow.");
            historyLines.push("");
            historyLines.push("| Week | Captured At (UTC) | Throughput | Open Blockers | Reopened |");
            historyLines.push("| --- | --- | ---: | ---: | ---: |");
            for (const wk of sortedWeeks) {
              historyLines.push(byWeek.get(wk));
            }
            historyLines.push("");

            fs.writeFileSync(historyPath, historyLines.join("\n"), "utf8");

      - name: Commit changes
        run: |
          if [[ -n "$(git status --porcelain docs/kanban.md docs/metrics-history.md)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add docs/kanban.md docs/metrics-history.md
            git commit -m "docs: refresh kanban and weekly metrics history"
            git push
          fi
